<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cipher Breaker 2099 — Phase 1</title>
  <meta name="theme-color" content="#0b0f1a">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" sizes="192x192" href="icons/icon-192.png">
  <style>
    :root{
      --bg:#0a0f18; --fg:#e6f0ff;
      --n1:#00f5d4; --n2:#7b61ff; --n3:#ff477e; --n4:#ffd166;
      --muted:#8ea0b8;
    }
    html,body{height:100%}
    body{
      margin:0; background:
        radial-gradient(1400px 900px at 70% -10%, #121a30 0%, transparent 60%),
        radial-gradient(900px 600px at -10% 110%, #1a1030 0%, transparent 60%),
        var(--bg);
      color:var(--fg); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      display:flex; align-items:center; justify-content:center; overflow:hidden;
    }
    .wrap{ width:min(1100px,96vw); }
    .card{
      border-radius:18px; background:rgba(255,255,255,.03);
      box-shadow:0 12px 38px rgba(0,0,0,.5), inset 0 0 0 1px rgba(255,255,255,.06);
      backdrop-filter: blur(8px);
    }
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 18px;}
    h1{margin:0; font-size:20px; letter-spacing:.6px;}
    .pill{padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.07); font-variant-numeric:tabular-nums;}
    .muted{color:var(--muted); font-size:13px}
    .btn{cursor:pointer; border:none; padding:10px 14px; border-radius:12px; font-weight:800; color:#0a0a0a; background:linear-gradient(90deg, var(--n1), var(--n2));}
    .btn:active{ transform:translateY(1px); }
    .canvas-wrap{ position:relative; width:100%; aspect-ratio: 16/9; }
    canvas{ width:100%; height:100%; display:block; border-radius:18px;
      background:linear-gradient(to bottom, rgba(0,0,0,.2), rgba(0,0,0,.5)), #080a10;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.06);
    }
    .scan{ position:absolute; inset:0; border-radius:18px; pointer-events:none;
      background: repeating-linear-gradient(to bottom, rgba(255,255,255,.05), rgba(255,255,255,.05) 1px, transparent 2px);
      mix-blend-mode:overlay; opacity:.22;
    }
    .overlay{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; }
    .panel{ text-align:center; max-width:80%; pointer-events:auto; }
    .title{ font-size:28px; font-weight:900; margin-bottom:6px; }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-weight:800; padding:2px 6px; border-radius:6px; background:rgba(255,255,255,.08); }
    .hidden{ display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <div>
          <h1>CIPHER BREAKER 2099 — Phase 1</h1>
          <div class="muted">Click wheels to rotate the glyphs. Match the target code exactly.</div>
        </div>
        <div class="pill">Target: <span id="targetTxt">— — —</span></div>
        <button id="btnReset" class="btn">New Code</button>
      </header>
      <div class="canvas-wrap">
        <canvas id="game" width="1200" height="675"></canvas>
        <div class="scan"></div>
        <div id="win" class="overlay hidden">
          <div class="panel">
            <div class="title" id="winTitle">CODE CRACKED</div>
            <div class="muted" style="margin-top:6px">Click <span class="kbd">New Code</span> or press <span class="kbd">N</span> to play again.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const cv = document.getElementById('game');
  const ctx = cv.getContext('2d');
  const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  cv.width = 1200 * dpr; cv.height = 675 * dpr; ctx.scale(dpr, dpr);

  const winOverlay = document.getElementById('win');
  const targetTxt = document.getElementById('targetTxt');
  const btnReset = document.getElementById('btnReset');

  const state = {
    w: 1200, h: 675,
    wheels: 3,
    glyphCount: 10,
    target: [0,0,0],
    values: [0,0,0],
    sel: 0,
    cracked: false
  };

  function rng(a,b){ return Math.random()*(b-a)+a; }
  function choice(arr){ return arr[Math.floor(Math.random()*arr.length)] }

  function drawGlyph(g, x, y, s){
    const neon = ['#00f5d4','#7b61ff','#ffd166','#ff477e'][g%4];
    const r = s*0.4;
    const lw = Math.max(2, s*0.08);
    // glow layer
    ctx.save();
    ctx.translate(x,y);
    ctx.lineCap='round'; ctx.lineJoin='round'; ctx.lineWidth=lw;
    ctx.strokeStyle=neon; ctx.fillStyle=neon; ctx.shadowBlur=s*0.25; ctx.shadowColor=neon;
    switch(g%10){
      case 0: poly([[0,-r],[r*0.86,r*0.5],[-r*0.86,r*0.5]], true); break;
      case 1: circle(0,0,r,false); circle(0,0,r*0.15,true); break;
      case 2: poly([[0,-r],[r,0],[0,r],[-r,0]], true); break;
      case 3: line(-r,0,r,0); line(0,-r,0,r); break;
      case 4: poly([[-r*0.8,-r*0.2],[0, r*0.5],[r*0.8,-r*0.2]], false); break;
      case 5: rect(-r*0.7,-r*0.7,r*1.4,r*1.4,false); break;
      case 6: {const a=Math.PI/3; ctx.beginPath(); for(let i=0;i<6;i++){const th=a*i; const px=Math.cos(th)*r,py=Math.sin(th)*r; i?ctx.lineTo(px,py):ctx.moveTo(px,py);} ctx.closePath(); ctx.stroke();} break;
      case 7: star(0,0,r*0.95,5); break;
      case 8: line(-r,0,r,0); circle(r*0.6,-r*0.4,r*0.12,true); break;
      case 9: arc(0,0,r, -Math.PI*0.2, Math.PI*0.2); arc(0,0,r, Math.PI*0.8, Math.PI*1.2); break;
    }
    ctx.restore();
    function line(x1,y1,x2,y2){ ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke(); }
    function circle(cx,cy,rr,fill){ ctx.beginPath(); ctx.arc(cx,cy,rr,0,Math.PI*2); fill?ctx.fill():ctx.stroke(); }
    function rect(x,y,w,h,fill){ ctx.beginPath(); ctx.rect(x,y,w,h); fill?ctx.fill():ctx.stroke(); }
    function poly(points, close){ ctx.beginPath(); points.forEach((p,i)=> i?ctx.lineTo(p[0],p[1]):ctx.moveTo(p[0],p[1])); if(close) ctx.closePath(); ctx.stroke(); }
    function star(cx,cy,R,n){ const r=R*0.45; ctx.beginPath(); for(let i=0;i<n*2;i++){ const ang=Math.PI*i/n - Math.PI/2; const rr = i%2? r:R; const px=cx+Math.cos(ang)*rr, py=cy+Math.sin(ang)*rr; i?ctx.lineTo(px,py):ctx.moveTo(px,py);} ctx.closePath(); ctx.stroke(); }
    function arc(cx,cy,rr,a1,a2){ ctx.beginPath(); ctx.arc(cx,cy,rr,a1,a2); ctx.stroke(); }
  }

  function randomCode(){
    const arr=[]; for(let i=0;i<state.wheels;i++) arr.push(Math.floor(Math.random()*state.glyphCount)); return arr;
  }

  function setNewPuzzle(){
    state.target = randomCode();
    state.values = randomCode();
    state.cracked = false;
    winOverlay.classList.add('hidden');
    targetTxt.textContent = state.target.join('  ');
  }

  cv.addEventListener('click', (e)=>{
    const rect = cv.getBoundingClientRect();
    const x = (e.clientX - rect.left) * (state.w/rect.width);
    const y = (e.clientY - rect.top) * (state.h/rect.height);
    const hit = pickWheel(x,y);
    if(hit>=0 && !state.cracked){ spin(hit, +1); }
  });

  window.addEventListener('keydown', (e)=>{
    if(e.key==='ArrowLeft'){ state.sel = (state.sel+state.wheels-1)%state.wheels; }
    if(e.key==='ArrowRight'){ state.sel = (state.sel+1)%state.wheels; }
    if(e.key==='ArrowUp' || e.key===' '){ spin(state.sel,+1); }
    if(e.key==='ArrowDown'){ spin(state.sel,-1); }
    if(e.key==='n' || e.key==='N'){ setNewPuzzle(); }
  });

  document.getElementById('btnReset').addEventListener('click', setNewPuzzle);

  function spin(idx, dir){
    if(state.cracked) return;
    state.values[idx] = (state.values[idx] + dir + state.glyphCount) % state.glyphCount;
    if(state.values.every((v,i)=> v===state.target[i])){
      state.cracked = true;
      document.getElementById('win').classList.remove('hidden');
    }
  }

  function pickWheel(x,y){
    const cy = state.h*0.58;
    const spacing = state.w*0.22;
    const start = state.w*0.5 - spacing;
    const R = 110;
    for(let i=0;i<state.wheels;i++){
      const cx = start + i*spacing;
      const dx = x - cx, dy = y - cy;
      if(dx*dx + dy*dy <= (R*R)) return i;
    }
    return -1;
  }

  function draw(){
    const w=state.w,h=state.h;
    ctx.clearRect(0,0,w,h);
    // grid
    ctx.save(); ctx.globalAlpha=0.09; ctx.strokeStyle='#7b61ff'; ctx.lineWidth=1;
    const gap=40; for(let x=0;x<=w;x+=gap){ ctx.beginPath(); ctx.moveTo(x+0.5,0); ctx.lineTo(x+0.5,h); ctx.stroke(); }
    for(let y=0;y<=h;y+=gap){ ctx.beginPath(); ctx.moveTo(0,y+0.5); ctx.lineTo(w,y+0.5); ctx.stroke(); }
    ctx.restore();
    // target banner
    ctx.save();
    ctx.globalAlpha=.9; ctx.fillStyle='rgba(255,255,255,.06)'; ctx.fillRect(w*0.1, h*0.15-30, w*0.8, 60);
    ctx.strokeStyle='rgba(255,255,255,.12)'; ctx.strokeRect(w*0.1+0.5, h*0.15-29.5, w*0.8-1, 59);
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.font='700 18px ui-sans-serif'; ctx.fillStyle='#8ea0b8';
    ctx.fillText('TARGET CODE', w*0.5, h*0.15-12);
    const gx0=w*0.5-160, gy0=h*0.15+8, gs=44, step=80;
    for(let i=0;i<state.wheels;i++){ drawGlyph(state.target[i], gx0+i*step, gy0, gs); }
    ctx.restore();
    // wheels
    const cy=h*0.58, spacing=w*0.22, start=w*0.5-spacing;
    for(let i=0;i<state.wheels;i++){
      const cx=start+i*spacing, R=110, rInner=88;
      ctx.save();
      const glow=['#00f5d4','#7b61ff','#ff477e'][i%3];
      ctx.shadowBlur=18; ctx.shadowColor=glow; ctx.strokeStyle='rgba(255,255,255,.14)';
      ctx.lineWidth=2; ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.stroke();
      ctx.globalAlpha=.2; ctx.beginPath(); ctx.arc(cx,cy,rInner,0,Math.PI*2); ctx.stroke(); ctx.globalAlpha=1;
      for(let t=0;t<state.glyphCount;t++){
        const th=(t/state.glyphCount)*Math.PI*2 - Math.PI/2;
        const x1=cx+Math.cos(th)*rInner, y1=cy+Math.sin(th)*rInner;
        const x2=cx+Math.cos(th)*(rInner-10), y2=cy+Math.sin(th)*(rInner-10);
        ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
      }
      drawGlyph(state.values[i], cx, cy, 90);
      if(state.sel===i){
        ctx.strokeStyle=glow; ctx.lineWidth=3; ctx.shadowBlur=22; ctx.shadowColor=glow;
        ctx.beginPath(); ctx.arc(cx,cy,R+10, -Math.PI*0.15, Math.PI*0.15); ctx.stroke();
      }
      ctx.restore();
    }
    // footer
    ctx.save(); ctx.fillStyle='#8ea0b8'; ctx.font='700 12px ui-sans-serif'; ctx.textAlign='center';
    ctx.fillText('Click wheels • ←/→ select • ↑/Space rotate • ↓ reverse • N = new code', w*0.5, h-20);
    ctx.restore();
    requestAnimationFrame(draw);
  }
  setNewPuzzle();
  draw();

  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=> navigator.serviceWorker.register('sw.js').catch(()=>{}));
  }
})();
</script>
</body>
</html>
